import{_ as s,c as n,o as a,a as l}from"./app.988cb848.js";const C=JSON.parse('{"title":"Simulated Annealing","description":"","frontmatter":{},"headers":[],"relativePath":"doc/ai/simulated_annealing.md","lastUpdated":1733832016000}'),p={name:"doc/ai/simulated_annealing.md"},o=l(`<h1 id="simulated-annealing" tabindex="-1">Simulated Annealing <a class="header-anchor" href="#simulated-annealing" aria-hidden="true">#</a></h1><p><strong>Simulated Annealing（模拟退火）</strong> 是一种基于自然物理现象的全局优化算法。它的灵感来自冶金学中的退火过程，即将材料加热到高温后逐渐冷却，以减少其内部缺陷，从而获得更稳定的结构。</p><p>在算法中，它通过在解空间中随机搜索，并结合一定的“接受次优解”的机制，逐步趋近问题的全局最优解。</p><h3 id="核心原理" tabindex="-1">核心原理： <a class="header-anchor" href="#核心原理" aria-hidden="true">#</a></h3><ol><li><p><strong>初始解与初始温度：</strong></p><ul><li>选定一个初始解，设定一个初始温度（较高值）。</li></ul></li><li><p><strong>邻域搜索：</strong></p><ul><li>在当前解的邻域中随机生成一个新解。</li></ul></li><li><p><strong>评价与接受准则：</strong></p><ul><li>如果新解的目标函数值更优，则接受新解。</li><li>如果新解较差，则按一定的概率接受它，概率通常由公式控制： [ P = e^{-\\Delta E / T} ] <ul><li>( \\Delta E ) 是目标函数值的差，( T ) 是当前温度。</li><li>随着温度降低，接受差解的概率减少。</li></ul></li></ul></li><li><p><strong>降温过程：</strong></p><ul><li>按一定规则逐步降低温度（通常称为退火计划）。</li></ul></li><li><p><strong>终止条件：</strong></p><ul><li>当温度降到某一阈值或达到最大迭代次数时，停止算法。</li></ul></li></ol><h3 id="模拟退火的特点" tabindex="-1">模拟退火的特点： <a class="header-anchor" href="#模拟退火的特点" aria-hidden="true">#</a></h3><ul><li><p><strong>优点：</strong></p><ul><li>能够跳出局部最优解，找到全局最优解或近似最优解。</li><li>对初始条件不敏感。</li></ul></li><li><p><strong>缺点：</strong></p><ul><li>收敛速度较慢。</li><li>参数（初始温度、降温规则等）的选择影响优化效果。</li></ul></li></ul><h3 id="常见应用" tabindex="-1">常见应用： <a class="header-anchor" href="#常见应用" aria-hidden="true">#</a></h3><ol><li><strong>组合优化问题：</strong><ul><li>旅行商问题（TSP）</li><li>排列与调度问题</li></ul></li><li><strong>函数优化：</strong><ul><li>处理多峰函数的全局最优解搜索。</li></ul></li><li><strong>机器学习：</strong><ul><li>超参数优化。</li></ul></li></ol><hr><h2 id="示例" tabindex="-1">示例 <a class="header-anchor" href="#示例" aria-hidden="true">#</a></h2><p>下面是一个使用 Python 实现 <strong>Simulated Annealing（模拟退火）</strong> 的简单示例。我们用一个常见的优化问题来演示：找到一个函数的全局最小值。</p><h3 id="示例问题" tabindex="-1">示例问题： <a class="header-anchor" href="#示例问题" aria-hidden="true">#</a></h3><p>优化函数 ( f(x) = x^2 + 4\\sin(5x) + 3\\cos(3x) ) 的最小值。</p><h3 id="实现代码" tabindex="-1">实现代码： <a class="header-anchor" href="#实现代码" aria-hidden="true">#</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> math</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> random</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> matplotlib</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">pyplot</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> plt</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 目标函数</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">objective_function</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">**</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sin</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">5</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cos</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> x</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 模拟退火算法</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">simulated_annealing</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">objective</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">bounds</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">initial_temp</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">cooling_rate</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">max_iter</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 初始化</span></span>
<span class="line"><span style="color:#A6ACCD;">    current_x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">uniform</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">bounds</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">],</span><span style="color:#82AAFF;"> bounds</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">])</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 随机初始解</span></span>
<span class="line"><span style="color:#A6ACCD;">    current_value </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">objective</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current_x</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    best_x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current_x</span></span>
<span class="line"><span style="color:#A6ACCD;">    best_value </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current_value</span></span>
<span class="line"><span style="color:#A6ACCD;">    temperature </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> initial_temp</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 记录优化过程</span></span>
<span class="line"><span style="color:#A6ACCD;">    history </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[(</span><span style="color:#A6ACCD;">current_x</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> current_value</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> iteration </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">max_iter</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 在当前解的邻域中随机生成新解</span></span>
<span class="line"><span style="color:#A6ACCD;">        candidate_x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current_x </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">uniform</span><span style="color:#89DDFF;">(-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 确保新解在边界范围内</span></span>
<span class="line"><span style="color:#A6ACCD;">        candidate_x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">max</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">bounds</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">],</span><span style="color:#82AAFF;"> min</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">candidate_x</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> bounds</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]))</span></span>
<span class="line"><span style="color:#A6ACCD;">        candidate_value </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">objective</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">candidate_x</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 计算能量差</span></span>
<span class="line"><span style="color:#A6ACCD;">        delta_value </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> candidate_value </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> current_value</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 决定是否接受新解</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> delta_value </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">or</span><span style="color:#A6ACCD;"> random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">random</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">exp</span><span style="color:#89DDFF;">(-</span><span style="color:#82AAFF;">delta_value </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> temperature</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">            current_x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> candidate_x</span></span>
<span class="line"><span style="color:#A6ACCD;">            current_value </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> candidate_value</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#676E95;font-style:italic;"># 更新最优解</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> current_value </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> best_value</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                best_x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current_x</span></span>
<span class="line"><span style="color:#A6ACCD;">                best_value </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current_value</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 降温</span></span>
<span class="line"><span style="color:#A6ACCD;">        temperature </span><span style="color:#89DDFF;">*=</span><span style="color:#A6ACCD;"> cooling_rate</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 保存当前状态</span></span>
<span class="line"><span style="color:#A6ACCD;">        history</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#89DDFF;">((</span><span style="color:#82AAFF;">current_x</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> current_value</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 停止条件</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> temperature </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1e-10</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> best_x</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> best_value</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> history</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 参数设置</span></span>
<span class="line"><span style="color:#A6ACCD;">bounds </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[-</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 搜索范围</span></span>
<span class="line"><span style="color:#A6ACCD;">initial_temp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 初始温度</span></span>
<span class="line"><span style="color:#A6ACCD;">cooling_rate </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.95</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 降温速率</span></span>
<span class="line"><span style="color:#A6ACCD;">max_iter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1000</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 最大迭代次数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 运行算法</span></span>
<span class="line"><span style="color:#A6ACCD;">best_x</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> best_value</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> history </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">simulated_annealing</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    objective_function</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> bounds</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> initial_temp</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> cooling_rate</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> max_iter</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 打印结果</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;最佳解: x = </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">best_x</span><span style="color:#C792EA;">:.4f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, f(x) = </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">best_value</span><span style="color:#C792EA;">:.4f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 可视化优化过程</span></span>
<span class="line"><span style="color:#A6ACCD;">x_values </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> _ </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> history</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">y_values </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">y </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> _</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> y </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> history</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">plt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">plot</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">history</span><span style="color:#89DDFF;">)),</span><span style="color:#82AAFF;"> y_values</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">label</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Objective Value</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">plt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">xlabel</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Iteration</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">plt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ylabel</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Objective Value</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">plt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">title</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Simulated Annealing Optimization Process</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">plt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">legend</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">plt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">show</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><h3 id="代码解析" tabindex="-1">代码解析： <a class="header-anchor" href="#代码解析" aria-hidden="true">#</a></h3><ol><li><strong>目标函数</strong>： <ul><li>( f(x) = x^2 + 4\\sin(5x) + 3\\cos(3x) ) 是多峰函数，用于测试优化算法的性能。</li></ul></li><li><strong>邻域搜索</strong>： <ul><li>在当前解的基础上加一个随机扰动，控制范围在 ([-1, 1]) 内。</li></ul></li><li><strong>接受准则</strong>： <ul><li>优于当前解直接接受；否则按一定概率接受次优解，概率由退火公式控制。</li></ul></li><li><strong>降温策略</strong>： <ul><li>每次迭代温度乘以 ( cooling_rate )（如 0.95）。</li></ul></li></ol><hr><h2 id="实例-kaggle-santa-claude-使用-simulated-annealing-求解-kaggle-2024-santa-问题" tabindex="-1">实例 kaggle: Santa Claude 使用 simulated annealing 求解 kaggle 2024 Santa 问题 <a class="header-anchor" href="#实例-kaggle-santa-claude-使用-simulated-annealing-求解-kaggle-2024-santa-问题" aria-hidden="true">#</a></h2><p><a href="https://www.kaggle.com/competitions/santa-2024" target="_blank" rel="noreferrer">kaggle: Santa Claude 2024</a></p><ul><li>概述: 将杂乱无章的文字段落拼接成一个困惑度最低的语句</li></ul><p>下面的代码摘录来自 kaggle 可能需要 kaggle 环境</p><ul><li>安装依赖</li></ul><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">notebook started..</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">!pip install </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">q </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">U transformers --no</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">index --find</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">links </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">kaggle</span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;">input</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">hf</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">libraries</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">transformers</span></span>
<span class="line"><span style="color:#A6ACCD;">!pip install </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">q </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">U accelerate --no</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">index --find</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">links </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">kaggle</span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;">input</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">hf</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">libraries</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">accelerate</span></span>
<span class="line"><span style="color:#A6ACCD;">!pip install </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">q </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">U bitsandbytes --no</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">index --find</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">links </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">kaggle</span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;">input</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">hf</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">libraries</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">bitsandbytes</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pip installs done!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> numpy </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> np</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> pandas </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> pd</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> random</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> math</span></span>
<span class="line"></span></code></pre></div><ul><li>加载评分器(困惑度计算模型)</li></ul><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> metric </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> PerplexityCalculator</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#gemma-2-9b (competition scoring metric)</span></span>
<span class="line"><span style="color:#A6ACCD;">scorer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PerplexityCalculator</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/kaggle/input/gemma-2/transformers/gemma-2-9b/2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><ul><li>加载数据(保存上次运行结果)</li></ul><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># Set to false to do a &quot;clean&quot; run</span></span>
<span class="line"><span style="color:#A6ACCD;">reuse_last_submission </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> reuse_last_submission</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    samples </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pd</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">read_csv</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/kaggle/input/santa-claude-output/submission.csv</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    samples </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pd</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">read_csv</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/kaggle/input/santa-2024/sample_submission.csv</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><ul><li>初始化评分</li></ul><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># Get actual mean value </span></span>
<span class="line"><span style="color:#A6ACCD;">scores </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> row </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">samples</span><span style="color:#89DDFF;">)):</span></span>
<span class="line"><span style="color:#A6ACCD;">    score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> scorer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_perplexity</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">samples</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">iloc</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">row</span><span style="color:#89DDFF;">].</span><span style="color:#F07178;">text</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">samples</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">iloc</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">row</span><span style="color:#89DDFF;">].</span><span style="color:#F07178;">text</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;Score: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">score</span><span style="color:#C792EA;">:.2f</span><span style="color:#F78C6C;">}</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    scores</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">score</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;Starting mean score: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">np</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mean</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">scores</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;">:.2f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><ul><li>开始 simulated annealing</li></ul><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># &quot;&gt;&quot; new version with score improved</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># &quot;&lt;&quot; new version with poorer score</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># &quot;-&quot; maintaining existing version</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">temp_start </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10.0</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">#how high a temperature we start with (prior 10)</span></span>
<span class="line"><span style="color:#A6ACCD;">temp_end </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.5</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;font-style:italic;">#final temperature (prior 0.2)</span></span>
<span class="line"><span style="color:#A6ACCD;">cooling_rate </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.95</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#how quick we cool each time we drop temp (prior 0.95)</span></span>
<span class="line"><span style="color:#A6ACCD;">steps_per_temp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#steps at each temperature (prior 20)    &lt;---- Increase this for a longer run (20 steps is about 3 hours)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">simulated_annealing_optimize</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">text</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">temp_start</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">temp_start</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">temp_end</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">temp_end</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">cooling_rate</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">cooling_rate</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">steps_per_temp</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">steps_per_temp</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">verbose</span><span style="color:#89DDFF;">=False):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Optimize word sequence using simulated annealing, handling NaN scores by randomizing.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    Args:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">       text: Input string of space-separated words to optimize</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">       temp_start: Starting temperature - higher means more random exploration</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">       temp_end: Ending temperature - lower means more selective at end</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">       cooling_rate: How fast temperature decreases each step</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">       steps_per_temp: How many swaps to try at each temperature</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">       verbose: Whether to print detailed progress</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    words </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> text</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    current </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> words</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    current_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> scorer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_perplexity</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Handling any NaNs...</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isnan</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current_score</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># Keep shuffling until we find a valid sequence</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">True:</span></span>
<span class="line"><span style="color:#A6ACCD;">            current </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> words</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">            random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shuffle</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            current_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> scorer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_perplexity</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">not</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isnan</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current_score</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#A6ACCD;">    best </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    best_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current_score</span></span>
<span class="line"><span style="color:#A6ACCD;">    temp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> temp_start</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;Start Temperature: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">temp</span><span style="color:#C792EA;">:.2f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, Initial score: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">current_score</span><span style="color:#C792EA;">:.2f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Main annealing loop - keep trying until we&#39;ve cooled down enough</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> temp </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> temp_end</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> _ </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">steps_per_temp</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># Do multiple attempts at each temperature</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#676E95;font-style:italic;"># Try improving sequence by swapping random pairs of words</span></span>
<span class="line"><span style="color:#A6ACCD;">            i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> j </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sample</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">words</span><span style="color:#89DDFF;">)),</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            neighbor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">            neighbor</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">],</span><span style="color:#A6ACCD;"> neighbor</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">j</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> neighbor</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">j</span><span style="color:#89DDFF;">],</span><span style="color:#A6ACCD;"> neighbor</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#676E95;font-style:italic;"># Get score for this arrangement, skip if invalid</span></span>
<span class="line"><span style="color:#A6ACCD;">            neighbor_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> scorer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_perplexity</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">neighbor</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isnan</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">neighbor_score</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">continue</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#676E95;font-style:italic;"># Accept better scores, sometimes accept worse ones based on temperature</span></span>
<span class="line"><span style="color:#A6ACCD;">            delta </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> neighbor_score </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> current_score</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> delta </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">or</span><span style="color:#A6ACCD;"> random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">random</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">exp</span><span style="color:#89DDFF;">(-</span><span style="color:#82AAFF;">delta </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> temp</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">                current </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> neighbor</span></span>
<span class="line"><span style="color:#A6ACCD;">                current_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> neighbor_score</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> current_score </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> best_score</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                    best </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">                    best_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current_score</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&gt;</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">end</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&lt;</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">end</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">end</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># Reduce temperature according to cooling schedule (AFTER all steps at this temperature)</span></span>
<span class="line"><span style="color:#A6ACCD;">        temp </span><span style="color:#89DDFF;">*=</span><span style="color:#A6ACCD;"> cooling_rate</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> verbose</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">Temperature: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">temp</span><span style="color:#C792EA;">:.2f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, Current score: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">current_score</span><span style="color:#C792EA;">:.2f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">Final score: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">best_score</span><span style="color:#C792EA;">:.2f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">best</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> best_score</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#uncomment for test run</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#text = samples.iloc[4].text</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#simulated_annealing_optimize(text, verbose=True)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><ul><li>实际计算 scores</li></ul><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">submission </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pd</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">DataFrame</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">columns</span><span style="color:#89DDFF;">=[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">text</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">scores </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Process each sample</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> idx</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> row </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> samples</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">iterrows</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">Processing sample </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">idx</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">...&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   optimized</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">simulated_annealing_optimize</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">row</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">text</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   scores</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">score</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;"># Add to submission dataframe</span></span>
<span class="line"><span style="color:#A6ACCD;">   submission</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">loc</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">idx</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> row</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">id</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">text</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> optimized</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-</span><span style="color:#89DDFF;">&quot;</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">50</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Print summary statistics</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">Score Summary:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;Submission mean score: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">np</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mean</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">scores</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;">:.2f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Save to CSV</span></span>
<span class="line"><span style="color:#A6ACCD;">submission</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to_csv</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">submission.csv</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">index</span><span style="color:#89DDFF;">=False)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">Submission file created!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">submission</span></span>
<span class="line"></span></code></pre></div><hr><h3 id="代码-chatgpt-解读" tabindex="-1">代码 chatgpt 解读 <a class="header-anchor" href="#代码-chatgpt-解读" aria-hidden="true">#</a></h3><p>这个代码实现了一个基于模拟退火（Simulated Annealing）的优化算法，目标是优化输入文本中单词的排列顺序，使得排列后的句子得分（由 <code>scorer.get_perplexity()</code> 函数提供）最优。</p><h3 id="代码解析-1" tabindex="-1"><strong>代码解析</strong> <a class="header-anchor" href="#代码解析-1" aria-hidden="true">#</a></h3><h4 id="_1-参数与配置" tabindex="-1"><strong>1. 参数与配置</strong> <a class="header-anchor" href="#_1-参数与配置" aria-hidden="true">#</a></h4><ul><li><code>temp_start</code>：初始温度，值越高，越倾向于随机探索。</li><li><code>temp_end</code>：最终温度，达到该值时算法停止，值越低，搜索更精确。</li><li><code>cooling_rate</code>：每次降温时的比例（0.95表示每轮温度减小5%）。</li><li><code>steps_per_temp</code>：每个温度下尝试的解的数量。值越高，优化过程越长，但可能找到更好的解。</li></ul><h4 id="_2-函数参数" tabindex="-1"><strong>2. 函数参数</strong> <a class="header-anchor" href="#_2-函数参数" aria-hidden="true">#</a></h4><ul><li><code>text</code>：输入字符串，包含以空格分隔的单词。</li><li><code>verbose</code>：是否打印详细的中间过程。</li></ul><h4 id="_3-函数主要逻辑" tabindex="-1"><strong>3. 函数主要逻辑</strong> <a class="header-anchor" href="#_3-函数主要逻辑" aria-hidden="true">#</a></h4><h5 id="step-1-数据准备" tabindex="-1"><strong>Step 1: 数据准备</strong> <a class="header-anchor" href="#step-1-数据准备" aria-hidden="true">#</a></h5><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">words </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> text</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">current </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> words</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">current_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> scorer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_perplexity</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span></code></pre></div><ul><li>输入字符串被分割成单词列表。</li><li><code>current</code> 是当前的单词排列。</li><li><code>current_score</code> 是当前排列的得分，使用 <code>scorer.get_perplexity()</code> 函数计算。</li></ul><h5 id="step-2-处理-nan" tabindex="-1"><strong>Step 2: 处理 NaN</strong> <a class="header-anchor" href="#step-2-处理-nan" aria-hidden="true">#</a></h5><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isnan</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current_score</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Shuffle until a valid score is found</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">True:</span></span>
<span class="line"><span style="color:#A6ACCD;">        current </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> words</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shuffle</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        current_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> scorer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_perplexity</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">not</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isnan</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">current_score</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"></span></code></pre></div><ul><li>如果当前排列的得分为 <code>NaN</code>（无效），就随机打乱单词顺序，直到找到一个有效得分。</li></ul><h5 id="step-3-初始化最优解" tabindex="-1"><strong>Step 3: 初始化最优解</strong> <a class="header-anchor" href="#step-3-初始化最优解" aria-hidden="true">#</a></h5><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">best </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">best_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current_score</span></span>
<span class="line"><span style="color:#A6ACCD;">temp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> temp_start</span></span>
<span class="line"></span></code></pre></div><ul><li>初始化当前解为最佳解 <code>best</code>。</li><li>记录当前最佳得分 <code>best_score</code>。</li><li>设置初始温度。</li></ul><h5 id="step-4-模拟退火主循环" tabindex="-1"><strong>Step 4: 模拟退火主循环</strong> <a class="header-anchor" href="#step-4-模拟退火主循环" aria-hidden="true">#</a></h5><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> temp </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> temp_end</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> _ </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">steps_per_temp</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 多次尝试改进解</span></span>
<span class="line"><span style="color:#A6ACCD;">        i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> j </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sample</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">words</span><span style="color:#89DDFF;">)),</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 随机选两个单词</span></span>
<span class="line"><span style="color:#A6ACCD;">        neighbor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        neighbor</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">],</span><span style="color:#A6ACCD;"> neighbor</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">j</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> neighbor</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">j</span><span style="color:#89DDFF;">],</span><span style="color:#A6ACCD;"> neighbor</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 交换两个单词</span></span>
<span class="line"></span></code></pre></div><ul><li>当温度高于 <code>temp_end</code> 时继续循环。</li><li>每个温度下尝试多次邻域搜索（根据 <code>steps_per_temp</code>）。</li><li>随机选取两个单词交换位置，生成一个“邻域解” <code>neighbor</code>。</li></ul><h5 id="step-5-评估新解" tabindex="-1"><strong>Step 5: 评估新解</strong> <a class="header-anchor" href="#step-5-评估新解" aria-hidden="true">#</a></h5><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">neighbor_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> scorer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_perplexity</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">neighbor</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isnan</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">neighbor_score</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">continue</span></span>
<span class="line"></span></code></pre></div><ul><li>计算新解的得分 <code>neighbor_score</code>。</li><li>如果得分为 <code>NaN</code>，跳过此次尝试。</li></ul><h5 id="step-6-接受准则" tabindex="-1"><strong>Step 6: 接受准则</strong> <a class="header-anchor" href="#step-6-接受准则" aria-hidden="true">#</a></h5><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">delta </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> neighbor_score </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> current_score</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> delta </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">or</span><span style="color:#A6ACCD;"> random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">random</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">exp</span><span style="color:#89DDFF;">(-</span><span style="color:#82AAFF;">delta </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> temp</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    current </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> neighbor</span></span>
<span class="line"><span style="color:#A6ACCD;">    current_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> neighbor_score</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> current_score </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> best_score</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        best </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        best_score </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> current_score</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&gt;</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">end</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&lt;</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">end</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">end</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><ul><li><strong>优于当前解</strong>（<code>delta &lt; 0</code>）直接接受。</li><li><strong>次优解</strong> 有一定概率接受，概率由温度和能量差决定： [ P = e^{-\\Delta / T} ] <ul><li>随着温度下降，接受次优解的概率降低。</li></ul></li><li>如果新解优于历史最优解，更新最优解。</li></ul><h5 id="step-7-降温" tabindex="-1"><strong>Step 7: 降温</strong> <a class="header-anchor" href="#step-7-降温" aria-hidden="true">#</a></h5><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">temp </span><span style="color:#89DDFF;">*=</span><span style="color:#A6ACCD;"> cooling_rate</span></span>
<span class="line"></span></code></pre></div><ul><li>按照降温速率减少当前温度。</li><li>当温度低于 <code>temp_end</code> 时停止。</li></ul><h5 id="step-8-输出结果" tabindex="-1"><strong>Step 8: 输出结果</strong> <a class="header-anchor" href="#step-8-输出结果" aria-hidden="true">#</a></h5><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">Final score: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">best_score</span><span style="color:#C792EA;">:.2f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">best</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> best_score</span></span>
<span class="line"></span></code></pre></div><ul><li>返回最佳单词排列和对应得分。</li></ul><h3 id="细节说明" tabindex="-1"><strong>细节说明</strong> <a class="header-anchor" href="#细节说明" aria-hidden="true">#</a></h3><ol><li><p><strong>“&gt;”, “&lt;”, “-”的输出</strong>：</p><ul><li><strong><code>&gt;</code></strong>：表示新解得分优于当前最优解。</li><li><strong><code>&lt;</code></strong>：表示新解被接受，但得分不如当前最优解。</li><li><strong><code>-</code></strong>：表示新解未被接受。</li></ul></li><li><p><strong>随机性与全局优化</strong>：</p><ul><li>初始高温使算法能探索更多随机排列，避免陷入局部最优。</li><li>降温使算法逐渐集中在更优的解附近。</li></ul></li><li><p><strong>优化目标</strong>：</p><ul><li>目标是通过调整单词顺序，使得句子得分（由 <code>scorer.get_perplexity</code> 计算）最低。</li></ul></li><li><p><strong>性能调节</strong>：</p><ul><li>增大 <code>steps_per_temp</code> 和减小 <code>cooling_rate</code> 会提高解的质量，但运行时间增加。</li></ul></li></ol><h3 id="改进建议" tabindex="-1"><strong>改进建议</strong> <a class="header-anchor" href="#改进建议" aria-hidden="true">#</a></h3><ul><li><strong>并行优化</strong>： <ul><li>可以通过多线程或多进程同时运行多个模拟退火实例，提高找到全局最优解的概率。</li></ul></li><li><strong>动态降温策略</strong>： <ul><li>根据得分变化动态调整降温速率，使优化更灵活。</li></ul></li><li><strong>更丰富的邻域操作</strong>： <ul><li>除交换两个单词，还可尝试更多复杂的邻域变化（如逆序一段）。</li></ul></li></ul>`,72),e=[o];function t(c,r,D,y,F,i){return a(),n("div",null,e)}const d=s(p,[["render",t]]);export{C as __pageData,d as default};
